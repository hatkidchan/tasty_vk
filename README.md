# tasty_vk

  * [Introduction или почему так а не иначе](#introduction)
  * [Установка](#Установка)
  * [Первый запуск](#Первый-запуск)
    * [Что нужно сначала](#Что-нужно-сначала)
    * [Простой echo-бот](#Простой-echo-бот)
  * [Работа с API](#Работа-с-api)

## Introduction
[![Почему tasty_vk а не как-то иначе](https://i.imgur.com/0ZWkOpx.png)](https://i.imgur.com/0ZWkOpx.png)

Да-да-да, мой дорогой, очередная либа для работы с VK API, с этими ужасно нестабильными методами, вечными ограничениями и прочими сладостями.

Скоро тут должна будет появиться документация по ней, так что радуйся что пока что я с тобой как с человеком, а не с программистом общаюсь. *ahem*

Начал пилить я её по образу и подобию [eternnoir/pyTelegramBotApi](https://github.com/eternnoir/pyTelegramBotApi), поэтому она должна будет прийтись по нраву любителям этой либы. Наверное. Надеюсь. ~~спасите~~

Разработка ведётся и будет вестись очень лениво, потому что ~~я могу себе позволить забрасывать проекты~~ мне просто не очень нравится работать с VK API. Хотя возможно потом на основе этой либы будет более-менее нормальный TUI-клиент, похожий на [vk-cli/vk](https://github.com/vk-cli/vk), только ~~наверное~~ без вылетов при сообщениях сообщества в чатах и наверное получше. Но без музыки. ~~не факт.~~

Заговорился я что-то. Короче многого не ждите, выкладываю ее только чтобы у меня было больше причин заставлять себя работать над чем-то почаще чем никогда.

## Установка

Сейчас кратко пробежимся по тому, как этим нечто пользоваться, как поставить и так далее.

Пока что есть только два способа поставить:

* Через pip как нечеловек

```
$ pip install git+https://github.com/hatkidchan/tasty_vk
```
* Установка через одно место (надо git)

```
$ git clone https://github.com/hatkidchan/tasty_vk tasty_vk
$ cd tasty_vk
$ python3 setup.py install
```

Первый способ не тестил, второй тоже.


## Первый запуск

### Что нужно сначала

_Надеюсь, что вы не будете запускать её на своем основном пользователе._

Нам нужно получить токен сообщества. Всё это делается в несколько простых шагов:
1. Идём на https://vk.com/вашпаблик?act=tokens
2. Тыкаем на **Создать ключ**
3. Выбираем права на управление сообществом, на сообщения, фотокарточки и документы
4. Создаём токен, подтверждаем его по телефону (это же так важно) и храним его в секрете
5. Идем в настройки **LongPoll API** и ставим версию `5.103` (разумеется, не забываем включить). На других версиях может сломаться
6. В типах событий выбираем всё что связано с сообщениями. В будущем постараюсь ловить все ивенты
7. Собственно, это всё. Токен есть, лонгполл настроен, летим дальше

### Простой echo-бот

**Внимание:** *этот пример для бота на сообщество. Для работы с пользователем всё чуточку проще и хуже одновременно. Опишу когда-нибудь и это.*

Класс `VK` из `__init__.py` хранит в себе методы отправки сообщений, в то время как его свойство `api` используется для работы со всем остальным. Альтернативно можно использовать метод `call` для вызова методов. При использовании `VK.api` можно удобно вызывать любой метод (`VK.api.messages.send()`).

Для начала создадим файл нашего первого бота. Например, `hello.py`. Откроем его в любимом редакторе и заполним следующим:

```python
from tasty_vk import VK
TOKEN = "<токен-полученный-ранее>"
GROUP = <ID-группы-числовой>

vk = VK(TOKEN, group_id=GROUP)
```

Это импортирует класс VK из библиотеки и создаст его экземпляр с нужным токеном.

После вышеописанного можно приступить к прослушиванию событий. Пока что все события надо слушать вручную, вскоре это будет выполняться с помощью хуков, создаваемых декораторами.

```python
for event in vk.longpoll.poll_events():
    print(event)
    if event.type == 'message_new':
        msg = event.object.message
        vk.send_message(msg.peer_id, msg.text or 'None')
```

Да, пока что всё вот так некрасиво работает. Скоро улучшим...

## Работа с API

Как говорилось ранее, любой метод можно вызвать через `VK.api.[....]()` или через `VK.call()`:

```python
>>> user = vk.api.users.get(user_ids=1)[0]
>>> print(user.first_name, user.last_name)
Павел Дуров
>>> hkc = vk.call('utils.resolveScreenName', screen_name='hatkidchan')
>>> hkc.object_id
483714053
>>> type(hkc)  # по умолчанию все результаты возвращаются как RDict
<class 'tasty_vk.utils.RDict'>
>>> # Чтобы возвращался простой dict, передаём аргумент _raw:
>>> hkc2 = vk.api.utils.resolveScreenName(screen_name='hatkidchan', _raw=True)
>>> type(hkc2)
<class 'dict'>
```

Класс `RDict` упрощает доступ к свойствам ответа, причем делает это рекурсивно:
```python
>>> friends = vk.api.friends.get(fields='online')
>>> friends.items[0].first_name, friends.items[0].last_name
Имя Файла
>>> friends.count
5
```

Также есть некоторые функции-помощники для отправки сообщений. Увы, многие из них работают только с токеном пользователя(

* `upload_document(path: str, peer_id: int=None, raw: bool=False) -> Any[str, dict]`
Используется для отправки документов. `peer_id` лучше указывать, несмотря на то, что у него нет значения. При `raw=True` возвращает словарь, описывающий документ (не `tasty_vk.utils.RDict`!!!), в противном случае возвращает строку вида `'doc{owner}_{id}'`
* `upload_graffiti(path: str, peer_id: int=None, raw: bool=False) -> Any[str, dict]`
* `upload_voice(path: str, peer_id: int=None, raw: bool=False) -> Any[str, dict]`
* `upload_photo(path: str, peer_id: int=None, raw: bool=False) -> Any[str, dict]`
* `send_document(path: str, peer_id: int, **kwargs) -> tasty_vk.utils.RDict`
Выгружает документ и отправляет его пользователю. По понятным причинам требует `peer_id`
* `send_graffiti(path: str, peer_id: int, **kwargs) -> tasty_vk.utils.RDict`
* `send_voice(path: str, peer_id: int, **kwargs) -> tasty_vk.utils.RDict`
* `send_photo(paths: Union[List[str], str], peer_id: int, **kwargs) -> tasty_vk.utils.RDict`
Выгружает фотографию (одну и более) и отправляет пользователю. Если строка - фотография одна. Если список строк - фотографий несколько
* `send_message(peer_id: int, message: str='', **kwargs) -> tasty_vk.utils.RDict`
Отправляет сообщение пользователю. Эта функция сама заботится о `random_id`

## TODO: хуки, больше примеров, сессии и прочее..

И многое другое, что я забыл сделать, да...
